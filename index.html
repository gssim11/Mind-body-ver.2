<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ ì²´ ë° ì‹¬ë¦¬ í†µí•© ë¶„ì„ ì†”ë£¨ì…˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f9fafb;
            color: #1f2937;
            scroll-behavior: smooth;
        }
        /* Progress Bar */
        #progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            z-index: 50;
        }
        #progress-bar {
            height: 100%;
            background-color: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Card Style */
        .card {
            background-color: white;
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            margin-bottom: 1.5rem;
            border: 1px solid rgba(229, 231, 235, 0.5);
            transition: transform 0.2s ease-in-out;
        }

        /* Section Titles */
        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f3f4f6;
        }
        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 1rem;
        }
        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
        }
        /* Section Colors */
        .text-blue-title { color: #2563eb; }
        .bg-blue-icon { background-color: #eff6ff; color: #2563eb; }
        .text-indigo-title { color: #4f46e5; } /* BMIìš© */

        /* Inputs */
        .input-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.375rem;
            display: block;
        }
        .input-field {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .input-field.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .error-msg {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 4px;
            display: none;
        }

        /* Direction Radio Style */
        .dir-radio-group {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
        }
        .dir-radio-label {
            flex: 1;
            cursor: pointer;
        }
        .dir-radio-input {
            display: none;
        }
        .dir-radio-box {
            display: block;
            text-align: center;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #6b7280;
            transition: all 0.2s;
        }
        .dir-radio-input:checked + .dir-radio-box {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
            font-weight: 700;
        }

        /* Rx Box */
        .rx-box {
            background-color: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 1.25rem;
            border-radius: 0 8px 8px 0;
            margin-bottom: 1rem;
        }
        .pilates-badge {
            display: inline-block;
            background-color: #e0e7ff;
            color: #4338ca;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 4px;
        }

        /* ê¸°ì¤€í‘œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .criteria-box {
            margin-top: 0.75rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            color: #4b5563;
        }
        .criteria-title {
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.5rem;
            display: block;
        }
        .criteria-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
        }

        /* Loading */
        #loading-overlay {
            backdrop-filter: blur(5px);
            background-color: rgba(255, 255, 255, 0.8);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Result Values */
        .result-text-blue { color: #2563eb; font-weight: 700; }
    </style>
</head>
<body class="pb-24">

    <!-- Progress Bar -->
    <div id="progress-container"><div id="progress-bar"></div></div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] hidden flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-gray-800 animate-pulse">ë°ì´í„° ë¶„ì„ ë° ì²˜ë°© ìƒì„± ì¤‘...</h2>
    </div>

    <!-- Main Content -->
    <div id="capture-area" class="max-w-5xl mx-auto p-4 md:p-8 bg-gray-50">
        
        <!-- Header -->
        <header class="text-center mb-10 pt-6">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4 tracking-tight">ì‹ ì²´ ë° ì‹¬ë¦¬ í†µí•© ë¶„ì„</h1>
            
            <div class="flex flex-col md:flex-row items-center justify-center gap-3 text-sm font-medium text-gray-600">
                <a href="https://physi.ansan.ac.kr/physi" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-gray-200 shadow-sm hover:border-blue-300 hover:text-blue-600 transition-all">
                    <i class="fa-solid fa-university text-blue-500"></i>
                    <span>ì•ˆì‚°ëŒ€í•™êµ ë¬¼ë¦¬ì¹˜ë£Œí•™ê³¼</span>
                    <i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-300"></i>
                </a>
                <span class="hidden md:inline text-gray-300">|</span>
                <a href="https://garp.kr/" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white rounded-full border border-gray-200 shadow-sm hover:border-teal-300 hover:text-teal-600 transition-all">
                    <i class="fa-solid fa-users-viewfinder text-teal-500"></i>
                    <span>êµ¿ì–¼ë¼ì¸ì¬í™œí•„ë¼í…ŒìŠ¤í˜‘íšŒ</span>
                    <i class="fa-solid fa-arrow-up-right-from-square text-xs text-gray-300"></i>
                </a>
            </div>
            
            <p class="mt-4 text-gray-500 text-sm bg-gray-100 inline-block px-3 py-1 rounded-lg">
                <i class="fa-solid fa-shield-halved mr-1"></i> ê°œì¸ ì •ë³´ëŠ” ì €ì¥ë˜ì§€ ì•Šê³  ë¸Œë¼ìš°ì €ì—ì„œë§Œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
            </p>
        </header>

        <form id="analysis-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            
            <!-- 1. ê¸°ë³¸ ì •ë³´ -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon bg-blue-100 text-blue-600"><i class="fa-solid fa-user"></i></div>
                    <h2 class="section-title">ê¸°ë³¸ ì •ë³´</h2>
                </div>
                <div class="space-y-4">
                    <div class="input-group">
                        <label>ì´ë¦„ <span class="text-gray-400 text-xs font-normal">(ì„ íƒ)</span></label>
                        <input type="text" id="name" class="input-field" placeholder="ì„±ëª… ì…ë ¥">
                    </div>
                    <div class="input-group">
                        <label>í‰ê°€ ë‚ ì§œ <span class="text-gray-400 text-xs font-normal">(ì„ íƒ)</span></label>
                        <input type="text" id="eval-date" class="input-field bg-gray-50" readonly>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="input-group">
                            <label class="text-blue-600">í‚¤ (cm) *</label>
                            <input type="text" inputmode="decimal" id="height" class="input-field border-blue-300" placeholder="175">
                             <p class="error-msg" id="height-error">í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        </div>
                        <div class="input-group">
                            <label class="text-blue-600">ëª¸ë¬´ê²Œ (kg) *</label>
                            <input type="text" inputmode="decimal" id="weight" class="input-field border-blue-300" placeholder="70">
                             <p class="error-msg" id="weight-error">ëª¸ë¬´ê²Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="text-blue-600">ë§Œ ë‚˜ì´ *</label>
                        <input type="text" inputmode="decimal" id="age" class="input-field border-blue-300" placeholder="25">
                         <p class="error-msg" id="age-error">ë‚˜ì´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    </div>
                    <div class="input-group">
                        <label class="text-blue-600">ì„±ë³„ *</label>
                        <div class="flex gap-3">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="gender" value="male" class="peer sr-only">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-blue-50 peer-checked:border-blue-500 peer-checked:text-blue-600 text-sm font-medium transition-all">ë‚¨ì„±</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="gender" value="female" class="peer sr-only">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-pink-50 peer-checked:border-pink-500 peer-checked:text-pink-600 text-sm font-medium transition-all">ì—¬ì„±</div>
                            </label>
                        </div>
                        <p class="error-msg" id="gender-error">ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
                    </div>
                    <div class="input-group">
                        <label>ìš°ì„¸ë°œ (Dominant) <span class="text-gray-400 text-xs font-normal">(ì„ íƒ)</span></label>
                        <div class="flex gap-3">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="dominant-leg" value="right" checked class="peer sr-only">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-indigo-50 peer-checked:border-indigo-500 peer-checked:text-indigo-600 text-sm font-medium transition-all">ì˜¤ë¥¸ìª½</div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" name="dominant-leg" value="left" class="peer sr-only">
                                <div class="text-center py-2 border rounded-lg peer-checked:bg-indigo-50 peer-checked:border-indigo-500 peer-checked:text-indigo-600 text-sm font-medium transition-all">ì™¼ìª½</div>
                            </label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ìš°ì„¸ë°œ ë‹¤ë¦¬ê¸¸ì´ (cm) <span class="text-gray-400 text-xs font-normal">(ì„ íƒ - Y-Balance ì‹œ í•„ìˆ˜)</span></label>
                        <input type="text" inputmode="decimal" id="leg-length" class="input-field" placeholder="ASIS ~ ë‚´ì¸¡ë³µì‚¬ë¼ˆ">
                    </div>
                </div>
            </div>

            <!-- 2. Y-Balance (Right) -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon bg-green-100 text-green-600"><i class="fa-solid fa-shoe-prints"></i></div>
                    <div>
                        <h2 class="section-title">Y-Balance (ì˜¤ë¥¸ìª½)</h2>
                        <p class="text-sm text-orange-600 font-extrabold mt-1">* ì˜¤ë¥¸ë°œ ì§€ì§€ / ì™¼ë°œ ë»—ê¸°</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="input-group">
                        <label>ì•ìª½ (Anterior)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="y-right-ant-1" class="input-field text-center" placeholder="1ì°¨">
                            <input type="text" inputmode="decimal" id="y-right-ant-2" class="input-field text-center" placeholder="2ì°¨">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ë’¤ì•ˆìª½ (Posteromedial)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="y-right-pm-1" class="input-field text-center" placeholder="1ì°¨">
                            <input type="text" inputmode="decimal" id="y-right-pm-2" class="input-field text-center" placeholder="2ì°¨">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ë’¤ê°€ìª½ (Posterolateral)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="y-right-pl-1" class="input-field text-center" placeholder="1ì°¨">
                            <input type="text" inputmode="decimal" id="y-right-pl-2" class="input-field text-center" placeholder="2ì°¨">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Y-Balance (Left) -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon bg-green-100 text-green-600"><i class="fa-solid fa-shoe-prints" style="transform: scaleX(-1);"></i></div>
                    <div>
                        <h2 class="section-title">Y-Balance (ì™¼ìª½)</h2>
                        <p class="text-sm text-orange-600 font-extrabold mt-1">* ì™¼ë°œ ì§€ì§€ / ì˜¤ë¥¸ë°œ ë»—ê¸°</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="input-group">
                        <label>ì•ìª½ (Anterior)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="y-left-ant-1" class="input-field text-center" placeholder="1ì°¨">
                            <input type="text" inputmode="decimal" id="y-left-ant-2" class="input-field text-center" placeholder="2ì°¨">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ë’¤ì•ˆìª½ (Posteromedial)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="y-left-pm-1" class="input-field text-center" placeholder="1ì°¨">
                            <input type="text" inputmode="decimal" id="y-left-pm-2" class="input-field text-center" placeholder="2ì°¨">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>ë’¤ê°€ìª½ (Posterolateral)</label>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="y-left-pl-1" class="input-field text-center" placeholder="1ì°¨">
                            <input type="text" inputmode="decimal" id="y-left-pl-2" class="input-field text-center" placeholder="2ì°¨">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. ìì„¸ í‰ê°€ (í†µí•©) -->
            <div class="card">
                <div class="section-header">
                    <div class="section-icon bg-purple-100 text-purple-600"><i class="fa-solid fa-person"></i></div>
                    <h2 class="section-title">ì •ì  ìì„¸ í‰ê°€</h2>
                </div>
                <div class="space-y-5">
                    <!-- ê³¨ë°˜ ë†’ì´ ì°¨ì´ ìˆ˜ì • (ë°©í–¥ ì„ íƒ ì¶”ê°€) -->
                    <div class="input-group">
                        <label class="mb-2">ê³¨ë°˜ ë†’ì´ ì°¨ì´ (Tilt Â°)</label>
                        <div class="dir-radio-group">
                            <label class="dir-radio-label">
                                <input type="radio" name="pelvis-dir" value="left" class="dir-radio-input" checked>
                                <span class="dir-radio-box">ì™¼ìª½ ë‚®ìŒ (-)</span>
                            </label>
                            <label class="dir-radio-label">
                                <input type="radio" name="pelvis-dir" value="right" class="dir-radio-input">
                                <span class="dir-radio-box">ì˜¤ë¥¸ìª½ ë‚®ìŒ (+)</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="pelvis-1" class="input-field text-center" placeholder="1ì°¨ (ìˆ«ìë§Œ)">
                            <input type="text" inputmode="decimal" id="pelvis-2" class="input-field text-center" placeholder="2ì°¨ (ìˆ«ìë§Œ)">
                        </div>
                    </div>

                    <!-- ì–´ê¹¨ ë†’ì´ ì°¨ì´ ìˆ˜ì • (ë°©í–¥ ì„ íƒ ì¶”ê°€) -->
                    <div class="input-group">
                        <label class="mb-2">ì–´ê¹¨ ë†’ì´ ì°¨ì´ (Tilt Â°)</label>
                        <div class="dir-radio-group">
                            <label class="dir-radio-label">
                                <input type="radio" name="shoulder-dir" value="left" class="dir-radio-input" checked>
                                <span class="dir-radio-box">ì™¼ìª½ ë‚®ìŒ (-)</span>
                            </label>
                            <label class="dir-radio-label">
                                <input type="radio" name="shoulder-dir" value="right" class="dir-radio-input">
                                <span class="dir-radio-box">ì˜¤ë¥¸ìª½ ë‚®ìŒ (+)</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="shoulder-1" class="input-field text-center" placeholder="1ì°¨ (ìˆ«ìë§Œ)">
                            <input type="text" inputmode="decimal" id="shoulder-2" class="input-field text-center" placeholder="2ì°¨ (ìˆ«ìë§Œ)">
                        </div>
                    </div>

                    <div class="input-group">
                        <label class="text-red-600">ë¨¸ë¦¬ì²™ì¶”ê° (CVA Â°)</label>
                        <p class="text-xs text-gray-400 mb-2">ê±°ë¶ëª© í‰ê°€ (ì •ìƒ: 50Â° ì´ìƒ)</p>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" inputmode="decimal" id="cva-1" class="input-field text-center" placeholder="1ì°¨">
                            <input type="text" inputmode="decimal" id="cva-2" class="input-field text-center" placeholder="2ì°¨">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. ì‹¬ë¦¬ ìƒíƒœ (ì „ì²´ ë„ˆë¹„) -->
            <div class="card md:col-span-2 lg:col-span-2">
                <div class="section-header">
                    <div class="section-icon bg-cyan-100 text-cyan-600"><i class="fa-solid fa-brain"></i></div>
                    <h2 class="section-title">ì‹¬ë¦¬ ìƒíƒœ ë¶„ì„</h2>
                </div>
                
                <div class="mb-8 bg-gray-50 p-5 rounded-xl border border-gray-100">
                    <label class="block font-bold text-gray-700 mb-3">í˜„ì¬ ìŠ¤íŠ¸ë ˆìŠ¤ ìˆ˜ì¤€ (VAS)</label>
                    <div class="flex items-center gap-4 mb-2">
                        <span class="text-xs text-gray-400">0 (ì—†ìŒ)</span>
                        <input type="range" id="stress-level" min="0" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-cyan-500">
                        <span class="text-xs text-gray-400">10 (ê·¹ì‹¬í•¨)</span>
                    </div>
                    <div class="text-center">
                        <span id="stress-value" class="text-3xl font-bold text-cyan-600">5</span>
                        <span class="text-sm text-gray-500">ì </span>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center">
                        <i class="fa-solid fa-clipboard-list mr-2 text-gray-400"></i>ì‹ ì²´ì  ìê¸°íš¨ëŠ¥ê° ì„¤ë¬¸
                    </h3>
                    <div id="self-efficacy-questions" class="space-y-3 max-h-80 overflow-y-auto pr-2 border border-gray-200 p-4 rounded-xl bg-white custom-scrollbar">
                        <!-- JS Generated -->
                    </div>
                </div>
            </div>
        </form>

        <!-- ë¶„ì„ ë²„íŠ¼ -->
        <div class="text-center mt-10 sticky bottom-6 z-40" data-html2canvas-ignore="true">
            <button id="analyze-btn" class="bg-blue-600 text-white font-bold py-4 px-12 rounded-full text-lg hover:bg-blue-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 flex items-center justify-center mx-auto w-full md:w-auto">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> í†µí•© ë¶„ì„ ë° ì†”ë£¨ì…˜ ìƒì„±
            </button>
        </div>

        <!-- ê²°ê³¼ ì„¹ì…˜ -->
        <div id="results-section" class="mt-12 hidden animate-fade-in-up">
            <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-t-2xl p-8 text-center text-white shadow-lg">
                <div class="inline-block bg-white/20 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-3">Analysis Report</div>
                <h2 class="text-3xl font-bold mb-2">í†µí•© ê¸°ëŠ¥ ë¶€ì „ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
                <p class="text-slate-300 text-sm" id="report-date"></p>
            </div>

            <div class="bg-white p-6 md:p-8 rounded-b-2xl shadow-lg border-x border-b border-gray-200 space-y-8">
                
                <div class="bg-gray-50 p-4 rounded-lg border-l-4 border-slate-500">
                    <h3 class="font-bold text-slate-800 mb-1">ğŸ“‹ ì¢…í•© í‰ê°€ ìš”ì•½</h3>
                    <p class="text-sm text-slate-600 leading-relaxed" id="executive-summary"></p>
                </div>

                <!-- ì¬í™œ ì²˜ë°© -->
                <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-blue-500 pl-3">
                        ì¬í™œ: ë§ì¶¤í˜• ê¸°ëŠ¥ë¶€ì „ êµì • ë° ìš´ë™ ì²˜ë°©
                    </h3>
                    <div id="rehab-prescription-content" class="space-y-4"></div>
                    <div class="mt-4 p-3 bg-red-50 text-red-700 text-xs rounded border border-red-100">
                        <strong><i class="fa-solid fa-triangle-exclamation mr-1"></i> ì£¼ì˜ì‚¬í•­:</strong> 
                        í†µì¦ì´ ë°œìƒí•˜ë©´ ì¦‰ì‹œ ìš´ë™ì„ ì¤‘ë‹¨í•˜ì„¸ìš”. ë³¸ ê²°ê³¼ëŠ” ë³´ì¡°ì  ì°¸ê³  ìë£Œì…ë‹ˆë‹¤.
                    </div>
                </div>

                <hr class="border-gray-100">

                 <!-- 1. ì‹ ì²´ êµ¬ì„± ë¶„ì„ (BMI) - NEW -->
                <div id="bmi-section-result">
                    <!-- JS Generated -->
                </div>

                <!-- 2. ì‹¬ë¦¬ ë¶„ì„ -->
                <div id="psych-section-result">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-cyan-500 pl-3">ì‹¬ë¦¬ ìƒíƒœ ë¶„ì„</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 ml-2 mb-4" id="psych-result-list"></ul>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="criteria-box">
                            <span class="criteria-title">ìŠ¤íŠ¸ë ˆìŠ¤ (VAS) í‰ê°€ ê¸°ì¤€</span>
                            <div class="criteria-row"><span class="text-green-600 font-bold">0 ~ 3ì </span><span>ì•ˆì •</span></div>
                            <div class="criteria-row"><span class="text-yellow-600 font-bold">4 ~ 6ì </span><span>ì£¼ì˜</span></div>
                            <div class="criteria-row"><span class="text-red-600 font-bold">7 ~ 10ì </span><span>ìœ„í—˜</span></div>
                        </div>
                        <div class="criteria-box">
                            <span class="criteria-title">ì‹ ì²´ì  ìê¸°íš¨ëŠ¥ê° í‰ê°€ ê¸°ì¤€</span>
                            <div class="criteria-row"><span class="text-blue-600 font-bold">88ì  ì´ìƒ</span><span>ë§¤ìš° ë†’ìŒ</span></div>
                            <div class="criteria-row"><span class="text-green-600 font-bold">66 ~ 87ì </span><span>ë†’ìŒ</span></div>
                            <div class="criteria-row"><span class="text-yellow-600 font-bold">44 ~ 65ì </span><span>ë³´í†µ</span></div>
                            <div class="criteria-row"><span class="text-red-600 font-bold">44ì  ë¯¸ë§Œ</span><span>ë‚®ìŒ</span></div>
                        </div>
                    </div>
                </div>

                <!-- Y-Balance ì •ëŸ‰ì  -->
                <div id="ybalance-quant-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-green-500 pl-3">Y-Balance Test ì •ëŸ‰ì  ë¶„ì„</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-green-50/50 p-4 rounded-lg" id="ybalance-score-content"></div>
                </div>

                <!-- Y-Balance í•´ì„ -->
                <div id="ybalance-interp-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-green-500 pl-3">Y-Balance Test ì˜ë¯¸ í•´ì„</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 ml-2" id="ybalance-interp-list"></ul>
                </div>

                <!-- ìì„¸ ë¶„ì„ -->
                <div id="posture-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 border-l-4 border-purple-500 pl-3">ìì„¸ ë¶„ì„</h3>
                    <ul class="list-disc list-inside space-y-2 text-gray-700 ml-2 mb-4" id="posture-result-list"></ul>
                     <div class="criteria-box">
                        <span class="criteria-title">ìì„¸ í‰ê°€ ê¸°ì¤€</span>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                            <div class="flex justify-between"><span class="font-semibold">ê³¨ë°˜/ì–´ê¹¨ ê¸°ìš¸ê¸°</span> <span>1.5Â° ë¯¸ë§Œ (ì •ìƒ)</span></div>
                            <div class="flex justify-between"><span class="font-semibold">ë¨¸ë¦¬ì²™ì¶”ê°(CVA)</span> <span>50Â° ì´ìƒ (ì •ìƒ)</span></div>
                        </div>
                    </div>
                </div>

                <!-- ì •ì„±ì  ë¶„ì„ -->
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-5">
                    <h3 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-eye mr-2"></i>ì›€ì§ì„ì˜ ì§ˆ(Quality) ê´€ì°° í¬ì¸íŠ¸</h3>
                    <ul class="list-disc list-inside space-y-1 text-sm text-blue-900/80 ml-1">
                        <li><strong>ë™ì  ë¬´ë¦ ì™¸ë°˜:</strong> ì§€ì§€í•˜ëŠ” ìª½ ë¬´ë¦ì´ ì•ˆìª½ìœ¼ë¡œ ë¬´ë„ˆì§ (ì¤‘ë‘”ê·¼ ì•½í™” ì˜ì‹¬)</li>
                        <li><strong>ê³¨ë°˜ í•˜ê°•:</strong> ë»—ëŠ” ìª½ ê³¨ë°˜ì´ ì•„ë˜ë¡œ ë–¨ì–´ì§</li>
                        <li><strong>ëª¸í†µ ë³´ìƒ ì‘ìš©:</strong> ë„ë‹¬ ê±°ë¦¬ë¥¼ ëŠ˜ë¦¬ê¸° ìœ„í•´ ìƒì²´ë¥¼ ê³¼ë„í•˜ê²Œ ìˆ™ì´ê±°ë‚˜ ë¹„í‹‚</li>
                        <li><strong>ë°œì˜ ë¶ˆì•ˆì •ì„±:</strong> ë°œ ì•„ì¹˜ ë¬´ë„ˆì§, ë°œê°€ë½ ì›€ì¼œì¥ (Clawing)</li>
                    </ul>
                </div>

            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center gap-3 mt-8 pb-10" data-html2canvas-ignore="true">
                <button id="save-image-btn" class="flex-1 sm:flex-none bg-gray-800 text-white font-bold py-3.5 px-8 rounded-xl hover:bg-gray-900 transition-colors shadow-lg flex items-center justify-center">
                    <i class="fa-solid fa-download mr-2"></i> ì´ë¯¸ì§€ë¡œ ì €ì¥
                </button>
                <button id="share-btn" class="flex-1 sm:flex-none bg-yellow-400 text-gray-900 font-bold py-3.5 px-8 rounded-xl hover:bg-yellow-500 transition-colors shadow-lg flex items-center justify-center">
                    <i class="fa-solid fa-comment mr-2"></i> ê²°ê³¼ ê³µìœ í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ... (Data & Init Logic) ...
        const efficacyQuestions = [
            { text: 'ë‚˜ëŠ” ë°˜ì‚¬ëŠ¥ë ¥ì´ ë›°ì–´ë‚˜ë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ì‹ ì²´ì  ì›€ì§ì„ì´ ë¯¼ì²©í•˜ì§€ ì•Šê³  ì„¸ë ¨ë˜ì§€ë„ ì•Šë‹¤.', positive: false },
            { text: 'ë‚˜ì˜ ìŒì„±ì€ ì¢‹ë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ì²´ê²©ì´ ì¢‹ë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê²¬ë””ì§€ ëª»í•œë‹¤.', positive: false },
            { text: 'ë‚˜ëŠ” ë‹¬ë¦¬ê¸°ì— ìì‹ ì´ ì—†ë‹¤.', positive: false },
            { text: 'ë‚˜ëŠ” ë‚˜ë¥¼ ê´´ë¡­íˆëŠ” ì‹ ì²´ì  ì•½ì ì„ ê°–ê³  ìˆë‹¤.', positive: false },
            { text: 'ë‚˜ëŠ” ì‹ ì²´ì˜ ìˆ™ë ¨ì„±ê³¼ ê´€ë ¨ëœ í…ŒìŠ¤íŠ¸ë¥¼ ë°›ì„ ë•Œ ìì‹ ì´ ì—†ë‹¤.', positive: false },
            { text: 'ë‚˜ëŠ” ì´ì„±ê³¼ì˜ ë§Œë‚¨ì—ì„œ ë‹¹ë‹¹í•˜ê²Œ ëŒ€í•œë‹¤.', positive: true },
            { text: 'ì‚¬ëŒë“¤ì€ ë°”ë¥´ì§€ ëª»í•œ ë‚˜ì˜ ìì„¸ ë•Œë¬¸ì— ë‚˜ë¥¼ ë¶€ì •ì ìœ¼ë¡œ ìƒê°í•œë‹¤.', positive: false },
            { text: 'ë‚˜ëŠ” ë‚˜ë³´ë‹¤ ì²´ê²©ì´ ë” ì¢‹ì€ ì‚¬ëŒê³¼ ì„œë¡œ ë‹¤ë¥´ë‹¤ëŠ” ì‚¬ì‹¤ì„ ì¸ì •í•œë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ê·¼ìœ¡ì´ ì•½í•˜ë‹¤.', positive: false },
            { text: 'ë‚˜ëŠ” ìŠ¤í¬ì¸ ì— ìì‹ ì´ ì—†ë‹¤.', positive: false },
            { text: 'ìš´ë™ì„ ìˆ˜ëŠ” ëŒ€ê°œ ë‚˜ë³´ë‹¤ ë” ë§ì€ ë§¤ë ¥ì„ ê°–ê³  ìˆì§€ ì•Šë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ë‚˜ë³´ë‹¤ ì˜ìƒê¸´ ì‚¬ëŒë“¤ì„ ë¶€ëŸ¬ì›Œí•œë‹¤.', positive: false },
            { text: 'ë‚˜ì˜ ì›ƒìŒì´ ìŠ¤ìŠ¤ë¡œë¥¼ ë‹¹í™©ì¼€ í•œë‹¤.', positive: false },
            { text: 'ë‚˜ëŠ” ë‚˜ì˜ ì²´ê²©ì— ëŒ€í•´ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ì–´ë–»ê²Œ ìƒê°í• ê¹Œ ê³ ë¯¼í•˜ì§€ ì•ŠëŠ”ë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ì†ì´ ì°¨ê³  ìŠµí•˜ê¸° ë•Œë¬¸ì— ì•…ìˆ˜í•˜ëŠ” ê²ƒì„ ì¢‹ì•„í•˜ì§€ ì•ŠëŠ”ë‹¤.', positive: false },
            { text: 'ë‚˜ì˜ ì£¼ë ¥(speed)ì€ ê¸´ë°•í•œ ê²½ê¸°ì—ì„œ í° ë„ì›€ì´ ëœë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ë‚˜ì˜ ë¶€ì£¼ì˜ë¡œ ì¸í•´ ìƒê¸°ëŠ” ìš°ì—°í•œ ì‚¬ê³ ë¥¼ ì˜ ë‹¹í•˜ì§€ ì•ŠëŠ”ë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ì•…ë ¥(ì¥ëŠ” í˜)ì´ ê°•í•˜ë‹¤.', positive: true },
            { text: 'ë‚˜ëŠ” ë¯¼ì²©í•˜ê¸° ë•Œë¬¸ì— ì§€ê¸ˆê¹Œì§€ ë‹¤ë¥¸ ë§ì€ ì‚¬ëŒë“¤ì´ í•  ìˆ˜ ì—†ëŠ” ê²ƒì„ í•´ì™”ë‹¤.', positive: true }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const dateStr = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;
            document.getElementById('eval-date').value = dateStr;
            document.getElementById('report-date').innerText = `í‰ê°€ì¼: ${dateStr}`;

            const slider = document.getElementById('stress-level');
            const val = document.getElementById('stress-value');
            slider.addEventListener('input', (e) => {
                val.textContent = e.target.value;
                if(e.target.value > 7) val.classList.replace('text-cyan-600', 'text-red-600');
                else val.classList.replace('text-red-600', 'text-cyan-600');
                updateProgress();
            });

            const qContainer = document.getElementById('self-efficacy-questions');
            const opts = ['ì „í˜€ ì•„ë‹˜', 'ì•„ë‹˜', 'ë³´í†µ', 'ê·¸ë ‡ë‹¤', 'ë§¤ìš° ê·¸ë ‡ë‹¤'];
            
            efficacyQuestions.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = "border-b border-gray-100 pb-3 last:border-0";
                let html = `<p class="text-sm font-medium text-gray-700 mb-2">Q${idx + 1}. ${q.text}</p>`;
                html += `<div class="flex justify-between px-1">`;
                opts.forEach((opt, i) => {
                    html += `
                        <label class="flex flex-col items-center cursor-pointer group">
                            <input type="radio" name="eq-${idx}" value="${i + 1}" class="mb-1 accent-blue-600" onchange="updateProgress()">
                            <span class="text-[10px] text-gray-400 group-hover:text-blue-500">${opt}</span>
                        </label>
                    `;
                });
                html += `</div>`;
                div.innerHTML = html;
                qContainer.appendChild(div);
            });

            document.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', updateProgress);
            });
        });

        function updateProgress() {
            const inputs = document.querySelectorAll('input[type="text"], input[type="number"], input[type="radio"]:checked');
            const filled = Array.from(inputs).filter(i => i.value !== '').length;
            const pct = Math.min(100, (filled / 40) * 100); 
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        document.getElementById('analyze-btn').addEventListener('click', () => {
            const heightInput = document.getElementById('height');
            const weightInput = document.getElementById('weight');
            const ageInput = document.getElementById('age');
            const genderInput = document.querySelector('input[name="gender"]:checked');

            let isValid = true;
            const check = (el, errId) => {
                if(!el.value) {
                    el.classList.add('error');
                    document.getElementById(errId).style.display = 'block';
                    isValid = false;
                } else {
                    el.classList.remove('error');
                    document.getElementById(errId).style.display = 'none';
                }
            };
            
            check(heightInput, 'height-error');
            check(weightInput, 'weight-error');
            check(ageInput, 'age-error');
            
            if(!genderInput) {
                document.getElementById('gender-error').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('gender-error').style.display = 'none';
            }
            
            if(!isValid) return;

            if(heightInput.value && (parseFloat(heightInput.value) < 50 || parseFloat(heightInput.value) > 250)) {
                 alert("í‚¤ ì…ë ¥ê°’ì´ ë¹„ì •ìƒì ì…ë‹ˆë‹¤."); isValid = false;
            }
            if(!isValid) return;

            const loader = document.getElementById('loading-overlay');
            loader.classList.remove('hidden');
            loader.classList.add('flex');

            setTimeout(() => {
                runAnalysis();
                loader.classList.add('hidden');
                loader.classList.remove('flex');
                
                const resultSec = document.getElementById('results-section');
                resultSec.classList.remove('hidden');
                const y = resultSec.getBoundingClientRect().top + window.pageYOffset - 40;
                window.scrollTo({top: y, behavior: 'smooth'});
                
            }, 1200);
        });

        function runAnalysis() {
            const getEffectiveValue = (id1, id2) => {
                const v1 = document.getElementById(id1).value;
                const v2 = document.getElementById(id2).value;
                const n1 = parseFloat(v1);
                const n2 = parseFloat(v2);
                if(!isNaN(n1) && !isNaN(n2)) return (n1 + n2) / 2;
                if(!isNaN(n1)) return n1;
                if(!isNaN(n2)) return n2;
                return null; 
            };

            const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
            const getMax = (id1, id2) => {
                 const v1 = document.getElementById(id1).value;
                 const v2 = document.getElementById(id2).value;
                 if(!v1 && !v2) return null;
                 return Math.max(parseFloat(v1)||0, parseFloat(v2)||0);
            };
            
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const legLen = getVal('leg-length');

            const rAnt = getMax('y-right-ant-1', 'y-right-ant-2');
            const rPm = getMax('y-right-pm-1', 'y-right-pm-2');
            const rPl = getMax('y-right-pl-1', 'y-right-pl-2');
            const lAnt = getMax('y-left-ant-1', 'y-left-ant-2');
            const lPm = getMax('y-left-pm-1', 'y-left-pm-2');
            const lPl = getMax('y-left-pl-1', 'y-left-pl-2');

            const getDirFactor = (name) => document.querySelector(`input[name="${name}"]:checked`).value === 'left' ? -1 : 1;
            const pelvisVal = getEffectiveValue('pelvis-1', 'pelvis-2');
            const shoulderVal = getEffectiveValue('shoulder-1', 'shoulder-2');
            const cva = getEffectiveValue('cva-1', 'cva-2');
            
            const pelvis = pelvisVal !== null ? Math.abs(pelvisVal) * getDirFactor('pelvis-dir') : null;
            const shoulder = shoulderVal !== null ? Math.abs(shoulderVal) * getDirFactor('shoulder-dir') : null;
            const stress = parseInt(document.getElementById('stress-level').value);

            const hasYBalance = (rAnt !== null && lAnt !== null) && legLen > 0;
            let rComp=0, lComp=0, antAsym=0, pmAsym=0, plAsym=0;

            if(hasYBalance) {
                rComp = (( (rAnt||0) + (rPm||0) + (rPl||0) ) / (3 * legLen) * 100).toFixed(1);
                lComp = (( (lAnt||0) + (lPm||0) + (lPl||0) ) / (3 * legLen) * 100).toFixed(1);
                antAsym = Math.abs((rAnt||0) - (lAnt||0)).toFixed(1);
                pmAsym = Math.abs((rPm||0) - (lPm||0)).toFixed(1);
                plAsym = Math.abs((rPl||0) - (lPl||0)).toFixed(1);
            }

            let effScore = 0, effCount = 0;
            efficacyQuestions.forEach((q, i) => {
                const el = document.querySelector(`input[name="eq-${i}"]:checked`);
                if(el) { effCount++; let v = parseInt(el.value); if(!q.positive) v = 6 - v; effScore += v; }
            });

            // --- BMI Calculation & Analysis ---
            let bmi = 0, bmiStatus = "", bmiColor = "", bmiSol = "";
            if(height > 0 && weight > 0) {
                bmi = (weight / ((height/100)**2)).toFixed(1);
                if(bmi < 18.5) {
                    bmiStatus = "ì €ì²´ì¤‘"; bmiColor = "text-blue-600";
                    bmiSol = "ê·¼ìœ¡ëŸ‰ ì¦ì§„ì„ ìœ„í•œ ì €í•­ì„± ìš´ë™ê³¼ ì¶©ë¶„í•œ ë‹¨ë°±ì§ˆ ì„­ì·¨ê°€ í•„ìš”í•©ë‹ˆë‹¤.";
                } else if(bmi <= 22.9) {
                    bmiStatus = "ì •ìƒ"; bmiColor = "text-green-600";
                    bmiSol = "í˜„ì¬ì˜ ê±´ê°•í•œ ì²´ì¤‘ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ ê·œì¹™ì ì¸ ìœ ì‚°ì†Œ ë° ê·¼ë ¥ ìš´ë™ì„ ì§€ì†í•˜ì„¸ìš”.";
                } else if(bmi <= 24.9) {
                    bmiStatus = "ë¹„ë§Œ ì „ë‹¨ê³„"; bmiColor = "text-orange-500";
                    bmiSol = "ì²´ì¤‘ ê´€ë¦¬ë¥¼ ìœ„í•´ ìœ ì‚°ì†Œ ìš´ë™ ë¹„ì¤‘ì„ ë†’ì´ê³ , ì‹ìŠµê´€ ì¡°ì ˆì„ ë³‘í–‰í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.";
                } else {
                    bmiStatus = "ë¹„ë§Œ"; bmiColor = "text-red-600";
                    bmiSol = "ê´€ì ˆ ë¶€ë‹´ì´ ì ì€ ìˆ˜ì¤‘ ìš´ë™ì´ë‚˜ ê°€ë²¼ìš´ ìœ ì‚°ì†Œë¶€í„° ì‹œì‘í•˜ì—¬ ì ì§„ì ìœ¼ë¡œ ê°•ë„ë¥¼ ë†’ì´ì„¸ìš”. ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
                }
                
                // BMI Section HTML Injection
                document.getElementById('bmi-section-result').innerHTML = `
                    <div class="card border-l-4 border-indigo-400">
                        <h3 class="section-title text-indigo-title mb-4">ì‹ ì²´ êµ¬ì„± ë¶„ì„ (BMI)</h3>
                        <div class="flex flex-col md:flex-row gap-6 items-center">
                            <div class="text-center flex-1">
                                <span class="text-gray-500 text-sm block mb-1">ë‚˜ì˜ BMI ì§€ìˆ˜</span>
                                <div class="text-4xl font-bold ${bmiColor}">${bmi} <span class="text-lg text-gray-400 font-normal">kg/mÂ²</span></div>
                                <span class="inline-block mt-2 px-3 py-1 bg-gray-100 rounded-full text-sm font-bold ${bmiColor}">${bmiStatus}</span>
                            </div>
                            <div class="flex-[2] w-full border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6">
                                <h4 class="font-bold text-gray-700 mb-2 flex items-center"><i class="fa-solid fa-lightbulb text-yellow-400 mr-2"></i>ë§ì¶¤ ì†”ë£¨ì…˜</h4>
                                <p class="text-sm text-gray-600 mb-4 leading-relaxed">${bmiSol}</p>
                                <div class="bg-gray-50 p-3 rounded text-xs text-gray-500">
                                    <span class="font-bold block mb-1 text-gray-400">[ì°¸ê³ ] ì•„ì‹œì•„-íƒœí‰ì–‘ ë¹„ë§Œ ê¸°ì¤€</span>
                                    <div class="flex justify-between mb-1"><span>ì €ì²´ì¤‘</span><span>&lt; 18.5</span></div>
                                    <div class="flex justify-between mb-1"><span>ì •ìƒ</span><span>18.5 ~ 22.9</span></div>
                                    <div class="flex justify-between mb-1"><span>ë¹„ë§Œ ì „ë‹¨ê³„</span><span>23 ~ 24.9</span></div>
                                    <div class="flex justify-between"><span>ë¹„ë§Œ</span><span>&ge; 25</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- RX Logic ---
            let rehabHTML = "";
            let summaryText = [];
            
            const createRxItem = (title, physio, pilates) => `
                <div class="rx-box">
                    <h4 class="text-lg font-bold text-gray-800 mb-2 flex items-center"><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>${title}</h4>
                    <div class="mb-3 pl-6 border-l-2 border-blue-200">
                        <strong class="text-blue-600 text-sm block mb-1">ë¬¼ë¦¬ì¹˜ë£Œì  ì²˜ë°© (Primary)</strong>
                        <p class="text-gray-700 text-sm leading-relaxed">${physio}</p>
                    </div>
                    <div class="pl-6 border-l-2 border-indigo-200">
                        <strong class="text-indigo-600 text-sm block mb-1">Pilates Solution (Sub)</strong>
                        <div class="flex flex-wrap gap-1">
                            ${pilates.map(p => `<span class="pilates-badge">${p}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;

            let issues = 0;

            // BMI Issue (Obesity)
            if(bmi >= 25) {
                issues++;
                summaryText.push("ì²´ì¤‘ ê´€ë¦¬ í•„ìš”");
                rehabHTML += createRxItem(
                    "ì²´ì¤‘ ê°ëŸ‰ ë° ê´€ì ˆ ë³´í˜¸",
                    "ê³¼ì²´ì¤‘ì€ ì²™ì¶”ì™€ ë¬´ë¦ ê´€ì ˆì— ë¶€í•˜ë¥¼ ì¤ë‹ˆë‹¤. ì¶©ê²©ì´ ì ì€ ìœ ì‚°ì†Œ ìš´ë™ê³¼ ì½”ì–´ ê°•í™”ê°€ ìš°ì„ ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.",
                    ["Footwork (Reformer)", "Swimming (Mat)", "Leg Press Standing (Chair)"]
                );
            }

            if(cva !== null && cva > 0 && cva < 50) {
                issues++;
                summaryText.push("ê±°ë¶ëª© ìì„¸");
                rehabHTML += createRxItem("ê±°ë¶ëª©(Forward Head) êµì •", "ê²½ì¶” ì‹¬ë¶€ êµ´ê³¡ê·¼(Deep Neck Flexor) ê°•í™”ì™€ í‰ì¶” ì‹ ì „ ê°€ë™ì„± í™•ë³´ê°€ í•„ìš”í•©ë‹ˆë‹¤.", ["Swan prep (Ladder barrel)", "Chest Expansion (Cadillac)", "Breast Stroke Prep (Mat)"]);
            }

            if(hasYBalance) {
                if(antAsym > 4.0) {
                    issues++;
                    summaryText.push("ë°œëª© ê°€ë™ì„± ë¹„ëŒ€ì¹­");
                    rehabHTML += createRxItem("ë°œëª© ê°€ë™ì„± ì œí•œ ë° ë¹„ëŒ€ì¹­", "ì „ë°© ë„ë‹¬ ê±°ë¦¬ê°€ ì§§ì€ ìª½ì˜ ì¢…ì•„ë¦¬ ê·¼ìœ¡(Gastrocnemius/Soleus) ë‹¨ì¶•ì´ ì˜ì‹¬ë©ë‹ˆë‹¤.", ["Calf Raises (Reformer)", "Running (Reformer)", "Heel Squeeze Prone (Mat)"]);
                }
                if(pmAsym > 6.0 || plAsym > 6.0) {
                    issues++;
                    summaryText.push("ë‘”ê·¼ ì•½í™” ë° ê³ ê´€ì ˆ ë¶ˆì•ˆì •");
                    rehabHTML += createRxItem("ë‘”ê·¼ ì•½í™” ë° ê³ ê´€ì ˆ ë¶ˆì•ˆì •", "ì§€ì§€í•˜ëŠ” ë‹¤ë¦¬ì˜ ì¤‘ë‘”ê·¼ ë° ê³ ê´€ì ˆ ì™¸íšŒì „ê·¼ ì•½í™”ë¡œ ì¸í•œ ë™ì  ë°¸ëŸ°ìŠ¤ ì €í•˜ì…ë‹ˆë‹¤.", ["Shoulder Bridge (Mat)", "Side Kick (Mat)", "Leg Press Standing (Chair)", "Frog (Reformer)"]);
                }
            }

            if((pelvis !== null && Math.abs(pelvis) >= 1.5) || (shoulder !== null && Math.abs(shoulder) >= 1.5)) {
                issues++;
                summaryText.push("ì‹ ì²´ ì¢Œìš° ë¶ˆê· í˜•");
                rehabHTML += createRxItem("ì‹ ì²´ ë¶ˆê· í˜• ë° ì²™ì¶” ì¸¡ë§Œ ê²½í–¥", "ê³¨ë°˜ê³¼ ì–´ê¹¨ì˜ ë†’ì´ ì°¨ì´ëŠ” ì²™ì¶”ì˜ ê¸°ëŠ¥ì  ì¸¡ë§Œì„ ìœ ë°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", ["Mermaid (Reformer)", "Side Bend (Mat)", "Spine Twist (Mat)", "Saw (Mat)"]);
            }

            if(stress >= 7) {
                issues++;
                summaryText.push("ë†’ì€ ìŠ¤íŠ¸ë ˆìŠ¤");
                rehabHTML += createRxItem("ìŠ¤íŠ¸ë ˆìŠ¤ì„± ê·¼ìœ¡ ê³¼ê¸´ì¥ ì™„í™”", "ë†’ì€ ìŠ¤íŠ¸ë ˆìŠ¤ëŠ” ìƒë¶€ ìŠ¹ëª¨ê·¼ê³¼ ëª© ê·¼ìœ¡ì˜ ê³¼ê¸´ì¥ì„ ìœ ë°œí•©ë‹ˆë‹¤.", ["Breathing", "Arm Circles (Reformer)", "Cat Stretch (Mat)"]);
            }

            if(issues === 0 && (hasYBalance || cva !== null || pelvis !== null)) {
                summaryText.push("ë§¤ìš° ì–‘í˜¸í•œ ì‹ ì²´ ìƒíƒœ");
                rehabHTML = `<div class="text-center p-8 bg-green-50 rounded-xl border border-green-100"><p class="text-green-800 font-bold text-lg">í˜„ì¬ ì¸¡ì •ëœ í•­ëª©ë“¤ì—ì„œ ì‹ ì²´ ê¸°ëŠ¥ ìƒíƒœê°€ ë§¤ìš° ì–‘í˜¸í•©ë‹ˆë‹¤!</p><div class="mt-4"><span class="pilates-badge">Teaser</span><span class="pilates-badge">Control Balance</span><span class="pilates-badge">Coordination</span></div></div>`;
            } else if (issues === 0) {
                 rehabHTML = `<div class="text-center p-8 text-gray-500">ì…ë ¥ëœ ë°ì´í„°ê°€ ì¶©ë¶„í•˜ì§€ ì•Šì•„ ì²˜ë°©ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>`;
            }

            document.getElementById('rehab-prescription-content').innerHTML = rehabHTML;
            const summaryElem = document.getElementById('executive-summary');
            summaryElem.innerHTML = issues > 0 ? `ë¶„ì„ ê²°ê³¼, ê·€í•˜ì˜ ì£¼ìš” íŠ¹ì§•ì€ <strong>[${summaryText.join(', ')}]</strong>ì…ë‹ˆë‹¤.` : (summaryText.length > 0 ? "ë¶„ì„ ê²°ê³¼, <strong>ì‹ ì²´ ë¶ˆê· í˜•ì´ë‚˜ ê¸°ëŠ¥ ë¶€ì „ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</strong>" : "ë°ì´í„°ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");

            // Psych
            let effMsg = "í‰ê°€ ë¯¸ì™„ë£Œ";
            if(effCount === efficacyQuestions.length) {
                 const max = efficacyQuestions.length * 5;
                 if(effScore >= max*0.8) effMsg = "ë§¤ìš° ë†’ìŒ"; else if(effScore >= max*0.6) effMsg = "ë†’ìŒ"; else if(effScore >= max*0.4) effMsg = "ë³´í†µ"; else effMsg = "ë‚®ìŒ";
            }
            document.getElementById('psych-result-list').innerHTML = `<li><strong class="text-gray-900">ìˆœê°„ ìŠ¤íŠ¸ë ˆìŠ¤:</strong> <span class="result-text-blue">${stress}ì </span> / 10ì </li><li><strong class="text-gray-900">ì‹ ì²´ì  ìê¸°íš¨ëŠ¥ê°:</strong> <span class="result-text-blue">${effScore}ì </span> / 110ì  <span class="text-sm text-gray-500 ml-2">(${effMsg})</span></li>`;

            // Y-Balance Sections (Hide if no data)
            if (hasYBalance) {
                document.getElementById('ybalance-quant-section').style.display = 'block';
                document.getElementById('ybalance-interp-section').style.display = 'block';
                document.getElementById('ybalance-score-content').innerHTML = `
                    <div class="text-center"><h4 class="font-bold text-gray-600 mb-2">ì¢…í•© ì ìˆ˜ (Composite)</h4><div class="flex justify-center gap-8"><div><span class="text-xs text-gray-400 block">Right</span><span class="text-xl font-bold text-blue-600">${rComp}%</span></div><div><span class="text-xs text-gray-400 block">Left</span><span class="text-xl font-bold text-blue-600">${lComp}%</span></div></div></div>
                    <div class="text-center border-l border-green-200 pl-4"><h4 class="font-bold text-gray-600 mb-2">ë¹„ëŒ€ì¹­ (Asymmetry)</h4><div class="flex justify-around text-sm"><div><span class="block text-gray-400">Ant</span><span class="${antAsym > 4 ? 'text-red-600 font-bold' : 'text-gray-700'}">${antAsym}cm</span></div><div><span class="block text-gray-400">PM</span><span class="${pmAsym > 6 ? 'text-red-600 font-bold' : 'text-gray-700'}">${pmAsym}cm</span></div><div><span class="block text-gray-400">PL</span><span class="${plAsym > 6 ? 'text-red-600 font-bold' : 'text-gray-700'}">${plAsym}cm</span></div></div></div>
                `;
                let antInterp = antAsym > 4 ? "4cm ì´ˆê³¼ (ì£¼ì˜: ë°œëª© ê°€ë™ì„± ì œí•œ)" : "ì •ìƒ ë²”ìœ„ (ëŒ€ì¹­)";
                let pmInterp = (pmAsym > 6 || plAsym > 6) ? "6cm ì´ˆê³¼ (ì£¼ì˜: ë‘”ê·¼ ì•ˆì •ì„± ë¶€ì¡±)" : "ì •ìƒ ë²”ìœ„ (ì•ˆì •ì„± ì–‘í˜¸)";
                document.getElementById('ybalance-interp-list').innerHTML = `<li><strong>ì•ìª½(Ant) ë¹„ëŒ€ì¹­:</strong> ${antInterp}</li><li><strong>í›„ë°©(PM/PL) ë¹„ëŒ€ì¹­:</strong> ${pmInterp}</li>`;
            } else {
                document.getElementById('ybalance-quant-section').style.display = 'none';
                document.getElementById('ybalance-interp-section').style.display = 'none';
            }

            // Posture Section (Hide if no data)
            if(pelvis !== null || shoulder !== null || cva !== null) {
                document.getElementById('posture-section').style.display = 'block';
                let html = "";
                if(pelvis !== null) html += `<li><strong>ê³¨ë°˜ ê¸°ìš¸ê¸°:</strong> ${pelvis.toFixed(1)}Â° (${Math.abs(pelvis) < 1.5 ? "ì •ìƒ" : "ë¶ˆê· í˜• (ì£¼ì˜)"})</li>`;
                if(shoulder !== null) html += `<li><strong>ì–´ê¹¨ ê¸°ìš¸ê¸°:</strong> ${shoulder.toFixed(1)}Â° (${Math.abs(shoulder) < 1.5 ? "ì •ìƒ" : "ë¶ˆê· í˜• (ì£¼ì˜)"})</li>`;
                if(cva !== null) html += `<li><strong>ë¨¸ë¦¬ì²™ì¶”ê°(CVA):</strong> ${cva.toFixed(1)}Â° (${cva >= 50 ? "ì •ìƒ" : "ê±°ë¶ëª© (ì£¼ì˜)"})</li>`;
                document.getElementById('posture-result-list').innerHTML = html;
            } else {
                document.getElementById('posture-section').style.display = 'none';
            }
        }

        // --- Save & Share ---
        const handleCapture = (callback) => {
            const btn = document.getElementById('save-image-btn');
            const origin = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ì²˜ë¦¬ ì¤‘...';
            
            document.querySelectorAll('input').forEach(input => {
                if(input.type === 'radio' || input.type === 'checkbox') {
                    if(input.checked) input.setAttribute('checked', 'checked');
                } else {
                    input.setAttribute('value', input.value);
                }
            });

            window.scrollTo(0,0);

            html2canvas(document.getElementById('capture-area'), {
                scale: 2, 
                useCORS: true, 
                backgroundColor: "#f9fafb",
                scrollY: 0,
                windowHeight: document.getElementById('capture-area').scrollHeight + 100, 
                ignoreElements: (el) => el.id === 'save-image-btn' || el.id === 'share-btn'
            }).then(canvas => {
                btn.innerHTML = origin;
                callback(canvas);
            }).catch(err => {
                console.error(err);
                btn.innerHTML = origin;
                alert("ì´ë¯¸ì§€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
        };

        document.getElementById('save-image-btn').addEventListener('click', () => {
            handleCapture((canvas) => {
                const link = document.createElement("a");
                link.download = `Result_${document.getElementById('name').value || 'Report'}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            });
        });

        document.getElementById('share-btn').addEventListener('click', () => {
            handleCapture((canvas) => {
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "report.png", { type: "image/png" });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: 'ì‹ ì²´ ë¶„ì„ ë¦¬í¬íŠ¸',
                                text: 'ë‚˜ì˜ ì‹ ì²´ ë° ì‹¬ë¦¬ í†µí•© ë¶„ì„ ê²°ê³¼ì…ë‹ˆë‹¤.'
                            });
                        } catch (err) {
                            console.log("Share failed/cancelled:", err);
                        }
                    } else {
                        alert("ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤. ì´ë¯¸ì§€ë¡œ ì €ì¥ë©ë‹ˆë‹¤.");
                        const link = document.createElement("a");
                        link.download = `Result_${document.getElementById('name').value || 'Report'}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    }
                });
            });
        });
    </script>
</body>
</html>
